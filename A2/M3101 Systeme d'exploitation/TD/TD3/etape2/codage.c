
#include "../commun/td3.h"
#include "../commun/palette.c"


extern Handler HANDLER_TABLE[PALETTE_SIZE];
extern char ALPHABET_PALETTE[PALETTE_SIZE];
extern char* NOM_FICHIERS[PALETTE_SIZE];

char minuscule(char c);



//choix de la palette a utiliser
char* palette_courante = ALPHABET_PALETTE;

int get_index_for_char(char) ;

static unsigned int _seed = 4;

void init_secret(int seed) {
    _seed = seed;
}

int next_number(int n){
    return (8253729 * n + 2396403);
}

int get_decalage(){
    _seed = next_number(_seed); 
    return (_seed%32767);
}

void codage(int in) {

    init_secret(_seed);

    unsigned char c;
    //int nbLus = -1;
    int desc;
    unsigned char index = 0;
    int nbLus = read(in, &c, 1);
    int decalage = get_decalage();

    while (nbLus != 0) {
        c = minuscule(c);

        if (97 <= c && c <= 122) {
            c = c + decalage % 26;
            if (c > 122)
                c = c - 26;


            if ((desc = open(get_filename_for_char(minuscule(c)), O_RDONLY)) == -1) { // check juste wr
                desc = open(get_filename_for_char(minuscule(c)), O_CREAT | O_WRONLY, 0666);
            } else {
                close(desc);
                desc = open(get_filename_for_char(minuscule(c)), O_APPEND | O_RDWR); // check juste wr
            }

            write(desc, &index, 1);
            close(desc);
            index++;
            nbLus = read(in, &c, 1);
        }
        else {
            nbLus = read(in, &c, 1);
            index++;
        }
    }
    close (in);
}

char minuscule(char c) {
    if (97 <= c && c <= 122)
        return c;
    else if (65 <= c && c <= 90)
        return 97 + c%65;
    return c;
}



void decodage(int out) {
    system("ls *.in > fileLS");
    if (open("fileLS", O_RDONLY) != -1) {
        int fLS = open("fileLS", O_RDONLY);
        char ch;
        char cLS;
        int nbLusLS = read(fLS, &cLS, 1);
        int decalage = get_decalage() + _seed;

        while (nbLusLS != 0) {


            int fIN = open(get_filename_for_char(cLS), O_RDONLY);
            unsigned char cIN;

            int nbLusIN = read(fIN, &cIN, 1);

            while (nbLusIN != 0) {
                printf("test1 : %d \n", nbLusIN);
                ch = cLS;
                if (97 <= ch && ch <= 122) {
                    ch = ch + decalage%26;
                    if (ch > 122)
                        ch = ch - 26;
                }
                printf("%d", ch);
                lseek(out, cIN, SEEK_SET);
                write(out, &ch, 1);

                nbLusIN = read(fIN, &cIN, 1);
            }

            while (cLS != '\n')
                read(fLS, &cLS, 1);

            nbLusLS = read(fLS, &cLS, 1);
            printf("test2 : %d \n", nbLusLS);

        }

    }

}


int main() {
    int fd = open("./message.txt", O_RDONLY);
    codage(fd);

    int out = open("./sortie.txt", O_CREAT | O_WRONLY, 0666);
    decodage(out);

}

