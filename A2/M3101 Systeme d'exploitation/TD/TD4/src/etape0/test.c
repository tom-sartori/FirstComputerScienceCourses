#include <stdio.h>
#include <unistd.h>

#define ALIGNMENT 8
#define ALIGN(size)(((size) + (ALIGNMENT -1)) & ~(ALIGNMENT -1))
#define ENTETE_SIZE (ALIGN(sizeof(bloc_entete)))

typedef struct bloc_entete {
    size_t taille;
    unsigned short libre : 1;}
        bloc_entete;


void* myalloc2(size_t t) {
    printf("Fonction myalloc : \n");

    size_t blk_size = ALIGN(ENTETE_SIZE + t);
    printf("Taille fichier + entete alignés : %zu \n", blk_size);

    void* adresseDep = sbrk(blk_size);
    printf("Adresse depart : %lu \n", adresseDep);

    void* adresseArr = sbrk(0);
    printf("Adresse arrive : %lu \n", adresseArr);

    void* bloc_utilisateur = (void*)adresseDep + ENTETE_SIZE;
    printf("Adresse depart utilisateur : %lu \n", bloc_utilisateur);

    bloc_entete* entete = (bloc_entete *)adresseDep;
    entete->taille = blk_size;
    entete->libre = 0;

    return bloc_utilisateur;
}

void* myalloc(size_t t) {
    size_t blk_size = ALIGN(ENTETE_SIZE + t);

    void* adresseDep = sbrk(blk_size);
    printf("Adresse depart : %lu \n", adresseDep);
    void* bloc_utilisateur = (void*)adresseDep + ENTETE_SIZE;

    bloc_entete* entete = (bloc_entete *)adresseDep;
    entete->taille = blk_size;
    entete->libre = 0;

    return bloc_utilisateur;
}


void myfree(void* ptr) {
    bloc_entete* entete = (bloc_entete*)((void*)ptr -ENTETE_SIZE);
    entete->libre = 1;
    return;
}


void initialiser_systeme(int adresse) {
    init = 1;
    adresse_base = adresse;
}



int main () {
    int taille = 1;
    printf("Taille fichier : %d \n", taille);
    int x = ALIGN(taille);
    printf("Taille fichier aligné : %d \n", x);
    printf("Taille entete %zu \n", ENTETE_SIZE);
    printf("Taille fichier + entete : %lu \n", taille + ENTETE_SIZE);

    int *p = myalloc(sizeof(int) * 4);
    *p = 5;
    printf("Adresse p : %lu \n", p);
    int t[10];
    printf("%d \n", *p);

    myfree(p);

}