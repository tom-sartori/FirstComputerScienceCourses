#include <stdio.h>
#include <unistd.h>

#define ALIGNMENT 8
#define ALIGN(size)(((size) + (ALIGNMENT -1)) & ~(ALIGNMENT -1))
#define ENTETE_SIZE (ALIGN(sizeof(bloc_entete)))

int init = 0;
void* adresse_base;

void initialiser_systeme(void* adresse);
void* myalloc(size_t t);
void* allouer_nouveau_bloc(size_t t);
void myfree(void* ptr);
void* recycler_bloc(size_t t);

typedef struct bloc_entete {
    size_t taille;
    unsigned short libre : 1;}
        bloc_entete;



void initialiser_systeme(void* adresse) {
    init = 1;
    adresse_base = adresse;
}

void* allouer_nouveau_bloc(size_t t) {
    printf("allouer_nouveau_bloc\n");
    size_t blk_size = ALIGN(ENTETE_SIZE + t);

    void* adresseDep = sbrk(blk_size);
    printf("Adresse depart : %p \n", adresseDep);
    void* bloc_utilisateur = (void*)adresseDep + ENTETE_SIZE;

    bloc_entete* entete = (bloc_entete *)adresseDep;
    entete->taille = blk_size;
    entete->libre = 0;

    return bloc_utilisateur;
}

void* recycler_bloc(size_t t) {
    printf("Recycler bloc\n");
    void* adresseDep = adresse_base;
    void* adresseFin = sbrk(0);

    while (adresseDep < adresseFin) {
        bloc_entete* entete = (bloc_entete*)(adresseDep);
        if (entete->libre == 0) {
            adresseDep = adresseDep + ENTETE_SIZE + entete->taille;
        }
        else {
            if (entete->taille <= t) {
                return (void*)adresseDep + ENTETE_SIZE;
            }
            else {
                adresseDep = adresseDep + ENTETE_SIZE + entete->taille;
            }
        }
    }
    return NULL;
}

void* myalloc(size_t t) {
    if (init == 0) {
        void* adresse = allouer_nouveau_bloc(t);
        initialiser_systeme((void*)adresse - ENTETE_SIZE);
        return adresse;
    }
    else {
        void* adresse = recycler_bloc(t);
        if (adresse_base == NULL) {
            allouer_nouveau_bloc(t);
        }
    }
    return NULL;
}


void myfree(void* ptr) {
    printf("myfree\n");
    bloc_entete* entete = (bloc_entete*)((void*)ptr -ENTETE_SIZE);
    entete->libre = 1;
    return;
}


int main () {
    int *p = myalloc(sizeof(int) * 4);
    *p = 5;

    int t[10];

    int* q = myalloc(sizeof(int) * 5);

    myfree(p);

    int* r = myalloc(sizeof(int) * 5);


}